## Goal
Deploy the portfolio Next.js application as a container to Azure Kubernetes Service (AKS) using Azure CLI and existing Kubernetes manifests.

## Project Information
AppName: portfolio
- Technology Stack: Next.js 15 (App Router), TypeScript, TailwindCSS
- API/Data: NextAuth (credentials), PostgreSQL via Drizzle ORM
- Containerization: Dockerfile present at repo root
- Kubernetes: Manifests under `k8s/apps/portfolio/base` (Flux-ready overlays)
- Secrets: `NEXTAUTH_SECRET` required in production; stored as `NEXTAUTH-SECRET` in Azure Key Vault and mapped to `NEXTAUTH_SECRET` in runtime. PostgreSQL credentials typically sourced from Azure Flexible Server.

## Azure Resources Architecture
```mermaid
flowchart LR
  Dev[Developer / GitHub Actions] -->|Push Image| ACR[(Azure Container Registry)]
  ACR -->|Pull| AKS[(Azure Kubernetes Service)]
  AKS -->|Ingress| Users[End Users]
  AKS -->|Env/Secrets| KeyVault[(Azure Key Vault)]
  AKS -->|DB Conn| Postgres[(Azure Database for PostgreSQL Flexible Server)]
```

Data flows:
- AKS pulls the container image from ACR.
- App uses `NEXTAUTH_SECRET` injected via K8s/Key Vault integration to sign/encrypt NextAuth JWTs.
- App connects to Azure PostgreSQL using `DATABASE_URL` or assembled AZURE_POSTGRES_*.

## Recommended Azure Resources
- Azure Kubernetes Service: Standard nodepool sized for web workload
- Azure Container Registry: Basic SKU
- Azure Key Vault: Store `NEXTAUTH-SECRET` and DB credentials
- Log Analytics Workspace + Container Insights for AKS
- (Existing) Azure Database for PostgreSQL Flexible Server

## Execution Steps
1) Provision infrastructure (idempotent):
   - Ensure ACR exists and AKS has pull access (AcrPull role for cluster identity).
   - Ensure Key Vault contains `NEXTAUTH-SECRET` (see scripts below).

2) Build and push multi-arch image:
   - Build: Dockerfile at repo root
   - Tag strategy: `{branch}-{commit}-{timestamp}` and `latest` for main

3) Prepare Kubernetes manifests:
   - Use existing kustomization in `k8s/apps/portfolio/base` or environment overlays
   - Ensure deployment references the just-pushed image tag
   - Ensure a K8s secret named `nextauth-secret` exists with key `NEXTAUTH_SECRET`

4) Deploy to AKS:
   - `kubectl apply -k k8s/apps/portfolio/base` (or overlay)
   - Verify rollout

5) Validation:
   - `kubectl get pods,svc,ingress -n <namespace>`
   - Check application health and logs

## Secret management quick steps
- Create or verify `NEXTAUTH-SECRET` in Key Vault:
  - `scripts/verify-nextauth-secret.sh <kv-name> --create`
- Export locally for dev/testing:
  - `source scripts/fetch-azure-kv-secrets.sh <kv-name>`

## Notes
- The repo enforces a production check for `NEXTAUTH_SECRET` in `src/lib/env.ts`. Missing secrets will fail fast with remediation guidance.
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: default

resources:
  - ../../base
  - istio-gateway.yaml
  - istio-virtualservice.yaml

# Exclude base Istio and GCP-specific resources
patches:
  - target:
      kind: Gateway
      name: portfolio-gateway
    patch: |-
      $patch: delete
      apiVersion: networking.istio.io/v1beta1
      kind: Gateway
      metadata:
        name: portfolio-gateway
  - target:
      kind: VirtualService
      name: portfolio-virtualservice
    patch: |-
      $patch: delete
      apiVersion: networking.istio.io/v1beta1
      kind: VirtualService
      metadata:
        name: portfolio-virtualservice
  - target:
      kind: ComputeAddress
      name: istio-gateway-ip
    patch: |-
      $patch: delete
      apiVersion: compute.cnrm.cloud.google.com/v1beta1
      kind: ComputeAddress
      metadata:
        name: istio-gateway-ip
  - target:
      kind: Certificate
      name: portfolio-tls-cert
    patch: |-
      $patch: delete
      apiVersion: cert-manager.io/v1
      kind: Certificate
      metadata:
        name: portfolio-tls-cert
  - path: deployment-patch.yaml
    target:
      kind: Deployment
      name: portfolio
  - target:
      kind: Deployment
      name: portfolio
    patch: |-
      - op: remove
        path: /spec/template/spec/containers/1
  - path: service-patch.yaml
    target:
      kind: Service
      name: portfolio

configMapGenerator:
  - name: portfolio-config
    behavior: merge
    literals:
      - NODE_ENV=production
      - NEXTAUTH_URL=https://www.cat-herding.net
      - AZURE_DEPLOYMENT=true

secretGenerator:
  - name: portfolio-secrets
    behavior: merge
    literals:
      - NEXTAUTH_SECRET=azure-nextauth-secret-change-me-in-production
  - name: portfolio-db-secret
    behavior: merge
    literals:
      - DATABASE_URL=postgresql://portfolio:change-me@localhost:5432/portfolio
  - name: portfolio-db-password
    behavior: merge
    literals:
      - password=change-me-in-production

# Azure-specific configuration
# This overlay adapts the base configuration for Azure AKS with Istio
# Uses AKS-managed Istio service mesh
# Gateway selector: istio: aks-istio-ingressgateway-external
